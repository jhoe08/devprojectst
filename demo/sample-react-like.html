<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Virtual DOM Example</title>
</head>
<body>
    <div id="app"></div>

    <script>
        // Simple Virtual DOM implementation
        function createElement(tag, props, ...children) {
            return { tag, props, children };
        }

        function render(virtualDOM, container) {
            const domNode = document.createElement(virtualDOM.tag);

            // Apply props safely
            for (const prop in virtualDOM.props) {
                domNode.setAttribute(prop, virtualDOM.props[prop]);
            }

            // Render children
            // virtualDOM.children.forEach(child => {
            //     console.log({child})
            //     if (typeof child === 'string') {
            //         domNode.appendChild(document.createTextNode(child));
            //     } else {
            //         render(child, domNode);
            //     }
            // });
            console.log({virtualDOM})
            if (typeof virtualDOM === String) {
                domNode.appendChild(document.createTextNode(virtualDOM))
            } else {
                render(virtualDOM, domNode)
            }


            container.appendChild(domNode);
            return domNode;
        }


        function updateElement(parent, newNode, oldNode, index = 0) {
            if (!oldNode) {
                parent.appendChild(render(newNode, document.createDocumentFragment()));
            } else if (!newNode) {
                parent.removeChild(parent.childNodes[index]);
            } else if (changed(newNode, oldNode)) {
                parent.replaceChild(render(newNode, document.createDocumentFragment()), parent.childNodes[index]);
            } else if (newNode.tag) {
                for (let i = 0; i < Math.max(newNode.children.length, oldNode.children.length); i++) {
                    updateElement(parent.childNodes[index], newNode.children[i], oldNode.children[i], i);
                }
            }
        }


        function changed(node1, node2) {
            return typeof node1 !== typeof node2 || 
                   (typeof node1 === 'string' && node1 !== node2) ||
                   node1.tag !== node2.tag;
        }

        // Simple Component System
        class Component {
            constructor(props) {
                this.props = props;
                this.state = {};
            }

            setState(newState) {
                this.state = { ...this.state, ...newState };
                this.render();
            }

            render() {
                // To be implemented in subclasses
            }
        }

        // Timer Component
        class Timer extends Component {
            constructor(props) {
                super(props);
                this.state = { time: new Date().toLocaleTimeString() };
                this.virtualDOM = null;
                this.container = document.getElementById('app'); // store container
                this.render(); // initial render
                setInterval(this.updateTime.bind(this), 1000);
            }

            updateTime() {
                this.setState({ time: new Date().toLocaleTimeString() });
            }

            // render() {
            //     const virtualDOM = createElement('div', {}, `Current time: ${this.state.time}`);
            //     if (this.virtualDOM) {
            //         updateElement(this.container, virtualDOM, this.virtualDOM);
            //     } else {
            //         render(virtualDOM, this.container);
            //     }
            //     this.virtualDOM = virtualDOM;
            // }

            render() {
                const virtualDOM = createElement('div', {}, `Current time: ${this.state.time}`);
                console.log("New virtualDOM:", virtualDOM); // always shows the object
                if (this.virtualDOM) {
                    updateElement(this.container, virtualDOM, this.virtualDOM);
                } else {
                    render(virtualDOM, this.container);
                }
                this.virtualDOM = virtualDOM;
            }

        }

        // Create and render the Timer component
        new Timer();
    </script>
</body>
</html>
